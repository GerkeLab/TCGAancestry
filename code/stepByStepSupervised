######----------------------------------------------------------------------------------------#####
# 									VCF to plink (ped and map)
######----------------------------------------------------------------------------------------#####

# error with original chr 1 vcf so had to remove problematic line and rerun on 22/26/2018
vcftools --gzvcf /share/NGS/public/1000_genomes_p3/ALL.chr1.phase3_shapeit2_mvncall_integrated_v5a.20130502.genotypes.vcf.gz --snps /share/lab_gerke/panCancer/data/intermediateData/tcga_snps.txt --plink --out /share/lab_gerke/panCancer/data/1000genomes/chr1.filtered.genotypes

for chr in {2..22}; do echo "module load vcftools; vcftools --gzvcf /share/NGS/public/1000_genomes_p3/ALL.chr${chr}.phase3_shapeit2_mvncall_integrated_v5a.20130502.genotypes.vcf.gz --snps /share/lab_gerke/panCancer/data/intermediateData/tcga_snps.txt --plink --out /share/lab_gerke/panCancer/data/1000genomes/chr${chr}.filtered.genotypes" | qsub -d. -l mem=64G -l walltime=100:00:00 -N 1000g_subs ; done

######----------------------------------------------------------------------------------------#####
# 								  plink (ped and map) to binary
######----------------------------------------------------------------------------------------#####

plink --file /share/lab_gerke/panCancer/data/1000genomes/vcftools_subsets/chr1.filtered.genotypes --make-bed --out /share/lab_gerke/panCancer/data/1000genomes/vcftools_subsets/1000g_subset_chr1

# exclude snp with multiple alleles (non-biallelic)
plink --bfile /share/lab_gerke/panCancer/data/1000genomes/vcftools_subsets/1000g_subset_chr8 --exclude 1000g_subset-merge.missnp --make-bed --out /share/lab_gerke/panCancer/data/1000genomes/vcftools_subsets/1000g_subset_chr8v2

######----------------------------------------------------------------------------------------#####
# 								  merge 1000 genomes chromosomes
######----------------------------------------------------------------------------------------#####

plink --bfile /share/lab_gerke/panCancer/data/1000genomes/vcftools_subsets/1000g_subset_v2 --exclude /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/tcga_other_1000g.missnp --make-bed --out /share/lab_gerke/panCancer/data/1000genomes/vcftools_subsets/1000g_subset_v3

plink --bfile /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/geno_matrix_other_binary_v7 --exclude /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/tcga_other_1000g.missnp --make-bed --out /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/geno_matrix_other_binary_v8

plink --bfile /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/geno_matrix_tumor_binary_v7 --exclude /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/tcga_other_1000g.missnp --make-bed --out /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/geno_matrix_tumor_binary_v8

plink --bfile /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/geno_matrix_normal_binary_v7 --exclude /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/tcga_other_1000g.missnp --make-bed --out /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/geno_matrix_normal_binary_v8

# merge 

plink --bfile /share/lab_gerke/panCancer/data/1000genomes/vcftools_subsets/1000g_subset_v3 --bmerge /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/geno_matrix_other_binary_v8 --out /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/tcga_other_1000g

plink --bfile /share/lab_gerke/panCancer/data/1000genomes/vcftools_subsets/1000g_subset_v3 --bmerge /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/geno_matrix_tumor_binary_v8 --out /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/tcga_tumor_1000g

plink --bfile /share/lab_gerke/panCancer/data/1000genomes/vcftools_subsets/1000g_subset_v3 --bmerge /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/geno_matrix_normal_binary_v8 --out /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/tcga_normal_1000g

# remove snps with more than 10% missing - helps filter out any snps that were only measured in tcga or 1000g or just a bad snp

plink --bfile /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/tcga_other_1000g --geno --make-bed --out /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/tcga_other_1000g_v2

plink --bfile /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/tcga_tumor_1000g --geno --make-bed --out /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/tcga_tumor_1000g_v2

plink --bfile /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/tcga_normal_1000g --geno --make-bed --out /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/tcga_normal_1000g_v2

######----------------------------------------------------------------------------------------#####
# 								  			run admixture
######----------------------------------------------------------------------------------------#####

echo "module add admixture; admixture --cv -B /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/tcga_other_1000g_v2.bed 5 -j4 --supervised" | qsub -d. -l walltime=999:00:00 -N supervised_other

echo "module add admixture; admixture --cv -B /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/tcga_tumor_1000g_v2.bed 5 -j4 --supervised" | qsub -d. -l walltime=999:00:00 -N supervised_tumor

echo "module add admixture; admixture --cv -B /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/tcga_normal_1000g_v2.bed 5 -j4 --supervised" | qsub -d. -l walltime=999:00:00 -N supervised_normal

######----------------------------------------------------------------------------------------#####
# 								  			 run pca
######----------------------------------------------------------------------------------------#####

plink --bfile /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/tcga_other_1000g_v2 --pca
plink --bfile /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/tcga_tumor_1000g_v2 --pca
plink --bfile /share/lab_gerke/panCancer/data/intermediateData/supervised_subsets/tcga_normal_1000g_v2 --pca